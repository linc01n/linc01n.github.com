<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: django | Coding, Coding, Coding]]></title>
  <link href="http://linc01n.github.com/blog/categories/django/atom.xml" rel="self"/>
  <link href="http://linc01n.github.com/"/>
  <updated>2013-10-08T22:54:35+08:00</updated>
  <id>http://linc01n.github.com/</id>
  <author>
    <name><![CDATA[Lincoln Lee]]></name>
    <email><![CDATA[git@lincoln.hk]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Django Admin: Auto Select Current User]]></title>
    <link href="http://linc01n.github.com/blog/2011/10/18/django-admin-auto-select-current-user/"/>
    <updated>2011-10-18T17:38:00+08:00</updated>
    <id>http://linc01n.github.com/blog/2011/10/18/django-admin-auto-select-current-user</id>
    <content type="html"><![CDATA[<h2>Background</h2>

<p>There are often times in developing a CMS need to mark down who created the record. Django provide a nice admin interface for us. But when we only use the default, user need to select who they are by themselves. We want to auto select for them and they can't pretend to be others.</p>

<h2>code</h2>

<p>In the django models.py, we have the following:</p>

<p>{% codeblock models.py lang:python %}
class Notes(models.Model):</p>

<pre><code>title = models.CharField(max_length=255)
content = models.TextField()
date = models.DateField()
created_by = models.ForeignKey(User, related_name="Created By")
</code></pre>

<p>{% endcodeblock %}</p>

<p>We want the created_by to be set automatically for the logged in user.</p>

<p>So in our admin:
{% codeblock admin lang:python %}
class NotesAdmin(admin.ModelAdmin):</p>

<pre><code>def formfield_for_foreignkey(self, db_field, request, **kwargs):
    if db_field.name == 'created_by':
        kwargs['queryset'] = User.objects.filter(username=request.user.username)
    return super(NotesAdmin, self).formfield_for_foreignkey(db_field, request, **kwargs)

def get_readonly_fields(self, request, obj=None):
    if obj is not None:
        return self.readonly_fields + ('created_by',)
    return self.readonly_fields

def add_view(self, request, form_url="", extra_context=None):
    data = request.GET.copy()
    data['created_by'] = request.user
    request.GET = data
    return super(NotesAdmin, self).add_view(request, form_url="", extra_context=extra_context)
</code></pre>

<p>admin.site.register(Notes, NotesAdmin)
{% endcodeblock %}</p>

<h2>explanation</h2>

<p>The add_view function help us to select the current user from the drop-down list.</p>

<p>The formfield_for_foreignkey help us to filter out other users.</p>

<p>By combining this two function we get:</p>

<p><img src="/images/created_by.jpg" alt="Created By" /></p>

<p>The last get_readonly_fields function make this field can't be edit after the creation.</p>
]]></content>
  </entry>
  
</feed>
